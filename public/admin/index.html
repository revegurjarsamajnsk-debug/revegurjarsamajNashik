<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Profile Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <style>
        /* [Existing CSS styles remain unchanged] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #FF6600;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
        }
        
        /* New Logout Button Style */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .btn-logout {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            background: #dc3545;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn-logout:hover {
            background: #c82333;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 3px solid #f0f0f0;
        }

        .tab-btn {
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="tel"] {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            width: 100%;
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 150px;
            border-radius: 50%;
            border: 4px solid #FF9933;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-submit, .btn-cancel, .btn-delete {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-submit {
            background: #667eea;
            color: #fff;
        }

        .btn-submit:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #6c757d;
            color: #fff;
        }

        .btn-delete {
            background: #dc3545;
            color: #fff;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .search-section {
            margin-bottom: 2rem;
        }

        .search-section input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .profile-card-mini {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            margin-bottom: 1rem;
            background: #fafafa;
            transition: all 0.3s;
        }

        .profile-card-mini:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .profile-card-mini img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #FF9933;
        }

        .profile-card-mini .info {
            flex: 1;
        }

        .profile-card-mini h4 {
            color: #333;
            margin-bottom: 0.3rem;
        }

        .profile-card-mini p {
            color: #666;
            font-size: 0.9rem;
        }

        .profile-card-mini button {
            padding: 0.6rem 1.2rem;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        #message {
            display: none;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        #message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        #message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header-section">
            <h1>Profile Management</h1>
            <button id="logoutButton" class="btn-logout">Logout</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('add')">Add New Profile</button>
            <button class="tab-btn" onclick="showTab('edit')">Edit Profile</button>
        </div>

        <div id="message"></div>

        <div id="add-tab" class="tab-content active">
            <h2>Add New Profile</h2>
            <form id="addProfileForm">
                <div class="form-group">
                    <label>नाव (Name)*</label>
                    <input type="text" name="नाव" required>
                </div>

                <div class="form-group">
                    <label>मुळगाव (Native Place)*</label>
                    <input type="text" name="मुळगाव" required>
                </div>

                <div class="form-group">
                    <label>मोबाईल नंबर (Mobile Number)*</label>
                    <input type="tel" name="मोबाईल नंबर" pattern="[0-9]{10}" required>
                </div>

                <div class="form-group">
                    <label>Area*</label>
                    <input type="text" name="Area" required>
                </div>

                <div class="form-group">
                    <label>Profile Image</label>
                    <input type="file" id="imageUpload" accept="image/*">
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <button type="submit" class="btn-submit">Add Profile</button>
            </form>
        </div>

        <div id="edit-tab" class="tab-content">
            <h2>Edit Profile</h2>
            
            <div class="search-section">
                <input type="text" id="searchProfile" placeholder="Search by name, native place, mobile, or area...">
            </div>

            <div id="profileList"></div>

            <div id="editForm" style="display:none;">
                <h3>Edit Profile</h3>
                <form id="updateProfileForm">
                    <input type="hidden" id="editProfileId">
                    
                    <div class="form-group">
                        <label>नाव (Name)*</label>
                        <input type="text" id="edit-नाव" required>
                    </div>

                    <div class="form-group">
                        <label>मुळगाव (Native Place)*</label>
                        <input type="text" id="edit-मुळगाव" required>
                    </div>

                    <div class="form-group">
                        <label>मोबाईल नंबर (Mobile Number)*</label>
                        <input type="tel" id="edit-मोबाईल नंबर" pattern="[0-9]{10}" required>
                    </div>

                    <div class="form-group">
                        <label>Area*</label>
                        <input type="text" id="edit-Area" required>
                    </div>

                    <div class="form-group">
                        <label>Current Image</label>
                        <div class="image-preview">
                            <img id="currentImage" alt="Current profile">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Change Image (optional)</label>
                        <input type="file" id="editImageUpload" accept="image/*">
                        <div id="editImagePreview" class="image-preview"></div>
                    </div>

                    <button type="submit" class="btn-submit">Update Profile</button>
                    <button type="button" onclick="deleteProfile()" class="btn-delete">Delete Profile</button>
                    <button type="button" onclick="cancelEdit()" class="btn-cancel">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allProfiles = [];
        let profilesFetched = false;

        // --- NEW SECURITY SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (!session) {
                    // If no one is logged in, redirect to the login page
                    window.location.href = 'login.html';
                }
            });
            
            // Setup live search listener
            document.getElementById('searchProfile').addEventListener('input', handleSearch);
        });
        
        // --- NEW LOGOUT FUNCTIONALITY ---
        document.getElementById('logoutButton').addEventListener('click', async () => {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Error logging out:', error);
            }
        });

        // Tab switching
        async function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            if (tab === 'add') {
                document.getElementById('add-tab').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('edit-tab').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                if (!profilesFetched) {
                    await fetchAllProfiles();
                }
            }
        }

        // Image preview handlers
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('editImageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editImagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Upload image to Supabase Storage
        async function uploadImage(file) {
            if (!file) return null;
            
            const fileExt = file.name.split('.').pop();
            const fileName = `public/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

            const { data, error } = await supabaseClient.storage
                .from('profile-images')
                .upload(fileName, file);

            if (error) {
                console.error('Error uploading image:', error);
                showMessage('Error uploading image: ' + error.message, 'error');
                return null;
            }

            const { data: urlData } = supabaseClient.storage
                .from('profile-images')
                .getPublicUrl(data.path);

            return urlData.publicUrl;
        }
        
        // --- NEW --- Delete an image from Supabase Storage
        async function deleteImage(imageUrl) {
            if (!imageUrl) return;

            // Extract the file path from the full URL
            const filePath = imageUrl.split('/profile-images/')[1];
            if (!filePath) return;

            const { error } = await supabaseClient.storage
                .from('profile-images')
                .remove([filePath]);

            if (error) {
                console.error('Error deleting old image:', error);
                // Don't show an error to the user, just log it.
            }
        }

        // Add new profile
        document.getElementById('addProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {};
            
            formData.forEach((value, key) => {
                profileData[key] = value;
            });

            // Upload image if provided
            const imageFile = document.getElementById('imageUpload').files[0];
            if (imageFile) {
                const imageUrl = await uploadImage(imageFile);
                if (imageUrl) {
                    profileData.Image = imageUrl;
                }
            }

            // Insert into database
            const { data, error } = await supabaseClient
                .from('profile')
                .insert([profileData]);

            if (error) {
                showMessage('Error adding profile: ' + error.message, 'error');
            } else {
                showMessage('Profile added successfully!', 'success');
                e.target.reset();
                document.getElementById('imagePreview').innerHTML = '';
                profilesFetched = false; // Invalidate cache to refetch on next edit tab visit
            }
        });

        // Fetch all profiles and store them
        async function fetchAllProfiles() {
            const container = document.getElementById('profileList');
            container.innerHTML = '<div class="loading">Loading profiles...</div>';
            
            const { data, error } = await supabaseClient.from('profile').select('*');

            if (error) {
                showMessage('Error fetching profiles: ' + error.message, 'error');
                container.innerHTML = '';
                return;
            }

            allProfiles = data;
            profilesFetched = true;
            displayProfiles(allProfiles);
        }

        // Live search handler
        function handleSearch() {
            if (!profilesFetched) return;
            const searchTerm = document.getElementById('searchProfile').value.toLowerCase().trim();
            
            const filtered = allProfiles.filter(profile => 
                (profile['नाव']?.toLowerCase().includes(searchTerm)) || 
                (profile['मोबाईल नंबर']?.includes(searchTerm)) ||
                (profile['मुळगाव']?.toLowerCase().includes(searchTerm)) ||
                (profile['Area']?.toLowerCase().includes(searchTerm))
            );

            displayProfiles(filtered);
        }

        // Display profile list
        function displayProfiles(profiles) {
            const container = document.getElementById('profileList');
            container.innerHTML = '';

            if (profiles.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">No profiles found</p>';
                return;
            }

            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'profile-card-mini';
                card.innerHTML = `
                    <img src="${profile.Image || 'https://via.placeholder.com/80'}" alt="${profile['नाव']}">
                    <div class="info">
                        <h4>${profile['नाव']}</h4>
                        <p>${profile['मुळगाव']} | ${profile['मोबाईल नंबर']}</p>
                        <p><strong>Area:</strong> ${profile.Area}</p>
                    </div>
                    <button onclick="editProfile(${profile.id})">Edit</button>
                `;
                container.appendChild(card);
            });
        }

        // Edit profile
        async function editProfile(id) {
            const profileData = allProfiles.find(p => p.id === id);
            if (!profileData) {
                showMessage('Could not find profile to edit.', 'error');
                return;
            }

            document.getElementById('editProfileId').value = profileData.id;
            document.getElementById('edit-नाव').value = profileData['नाव'];
            document.getElementById('edit-मुळगाव').value = profileData['मुळगाव'];
            document.getElementById('edit-मोबाईल नंबर').value = profileData['मोबाईल नंबर'];
            document.getElementById('edit-Area').value = profileData.Area;
            document.getElementById('currentImage').src = profileData.Image || 'https://via.placeholder.com/150';

            document.getElementById('profileList').style.display = 'none';
            document.getElementById('searchProfile').style.display = 'none';
            document.getElementById('editForm').style.display = 'block';
        }

        // Update profile --- MODIFIED ---
        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editProfileId').value;
            const oldProfileData = allProfiles.find(p => p.id == id);
            
            const profileData = {
                'नाव': document.getElementById('edit-नाव').value,
                'मुळगाव': document.getElementById('edit-मुळगाव').value,
                'мобіль नंबर': document.getElementById('edit-мобіль नंबर').value,
                'Area': document.getElementById('edit-Area').value
            };

            const imageFile = document.getElementById('editImageUpload').files[0];
            if (imageFile) {
                const imageUrl = await uploadImage(imageFile);
                if (imageUrl) {
                    profileData.Image = imageUrl;
                    // If a new image was uploaded, delete the old one
                    if(oldProfileData && oldProfileData.Image) {
                        await deleteImage(oldProfileData.Image);
                    }
                }
            }

            const { data, error } = await supabaseClient
                .from('profile')
                .update(profileData)
                .eq('id', id);

            if (error) {
                showMessage('Error updating profile: ' + error.message, 'error');
            } else {
                showMessage('Profile updated successfully!', 'success');
                profilesFetched = false; // Invalidate cache to refetch
                cancelEdit();
            }
        });

        // Delete profile --- MODIFIED ---
        async function deleteProfile() {
            if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
                return;
            }

            const id = document.getElementById('editProfileId').value;
            const profileToDelete = allProfiles.find(p => p.id == id);

            // First, delete the profile from the database
            const { error: dbError } = await supabaseClient
                .from('profile')
                .delete()
                .eq('id', id);

            if (dbError) {
                showMessage('Error deleting profile: ' + dbError.message, 'error');
            } else {
                // If the database deletion was successful, delete the image
                if(profileToDelete && profileToDelete.Image) {
                    await deleteImage(profileToDelete.Image);
                }
                
                showMessage('Profile deleted successfully!', 'success');
                profilesFetched = false; // Invalidate cache
                cancelEdit();
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('profileList').style.display = 'block';
            document.getElementById('searchProfile').style.display = 'block';
            document.getElementById('editImagePreview').innerHTML = '';
            document.getElementById('editImageUpload').value = ''; // Clear the file input
            
            // If profiles were not fetched, fetch them now
            if(!profilesFetched) {
                fetchAllProfiles();
            } else {
                handleSearch(); // Otherwise, just refresh the displayed list
            }
        }

        // Show message
        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = `${type}`;
            msgDiv.style.display = 'block';
            setTimeout(() => msgDiv.style.display = 'none', 4000);
        }
    </script>
</body>
</html>